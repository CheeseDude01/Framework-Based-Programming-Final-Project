<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Thrift Shop System</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center py-6 mb-8 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-indigo-700">The Go Thrift Shop üõçÔ∏è</h1>
            <p class="text-gray-500 mt-2">API running at: <code class="font-mono text-sm text-red-500">http://localhost:8080</code></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section id="add-item-section" class="lg:col-span-1 p-6 bg-white rounded-xl shadow-lg h-min">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">List an Item (Owner)</h2>
                <form id="addItemForm" class="space-y-4">
                    <div>
                        <label for="ownerId" class="block text-sm font-medium text-gray-700">Your User ID</label>
                        <input type="text" id="ownerId" value="user_alice" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="itemName" value="Rare Comic Book" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="itemDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="itemDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">Mint condition, first edition.</textarea>
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium text-gray-700">Asking Price ($)</label>
                        <input type="number" id="itemPrice" value="50.00" step="0.01" min="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Add Item
                    </button>
                    <div id="addItemMessage" class="mt-3 text-center text-sm font-medium"></div>
                </form>
            </section>

            <section id="item-listing" class="lg:col-span-2 p-6 bg-white rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-800">Available Items</h2>
                    <button onclick="fetchItems()" class="text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.564 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H8a1 1 0 010 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm13 8a1 1 0 01-1 1h-2.101a7.002 7.002 0 01-11.601-2.564 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H12a1 1 0 110 2h4a1 1 0 011-1v-4a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                        Refresh
                    </button>
                </div>
                
                <div id="itemList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p id="loadingMessage" class="text-center text-gray-500 col-span-full">Loading items...</p>
                </div>

                <div id="noItemsMessage" class="hidden text-center text-gray-500 mt-6">No items currently available. Add one above!</div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        const itemListContainer = document.getElementById('itemList');
        const loadingMessage = document.getElementById('loadingMessage');
        const noItemsMessage = document.getElementById('noItemsMessage');
        const addItemForm = document.getElementById('addItemForm');
        const addItemMessage = document.getElementById('addItemMessage');

        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = 'mt-3 text-center text-sm font-medium ' + (isError ? 'text-red-600' : 'text-green-600');
            setTimeout(() => element.textContent = '', 5000);
        }

        async function fetchItems() {
            loadingMessage.classList.remove('hidden');
            noItemsMessage.classList.add('hidden');
            itemListContainer.innerHTML = ''; 

            try {
                const response = await fetch(`${API_BASE_URL}/items`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const items = await response.json();
                renderItems(items);

                if (items.length === 0) {
                    noItemsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching items:", error);
                loadingMessage.textContent = 'Error: Could not connect to Go server (Is it running on port 8080?)';
                loadingMessage.className = 'text-center text-red-600 col-span-full font-bold';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function addItem(event) {
            event.preventDefault();

            const ownerId = document.getElementById('ownerId').value;
            const name = document.getElementById('itemName').value;
            const description = document.getElementById('itemDescription').value;
            const price = parseFloat(document.getElementById('itemPrice').value);

            try {
                const response = await fetch(`${API_BASE_URL}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ownerId, name, description, price })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(addItemMessage, `Item added! ID: ${result.id}`, false);
                    addItemForm.reset();
                    document.getElementById('ownerId').value = ownerId;
                    fetchItems();
                } else {
                    showMessage(addItemMessage, `Error adding item: ${result.error || response.statusText}`, true);
                }
            } catch (error) {
                console.error("Error adding item:", error);
                showMessage(addItemMessage, 'Network error. Could not connect to API.', true);
            }
        }

        async function buyItem(itemId, itemPrice) {
            const buyerId = prompt("Enter your Buyer ID to confirm purchase:");
            if (!buyerId) return;

            if (buyerId === document.getElementById('ownerId').value) {
                alert("You cannot buy your own item!");
                return;
            }

            if (!confirm(`Confirm purchase of Item ID ${itemId} for $${itemPrice.toFixed(2)}?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/items/${itemId}/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buyerId })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Success! Item ${itemId} sold for $${result.finalPrice.toFixed(2)}. Status: ${result.item.status}`);
                    fetchItems();
                } else {
                    alert(`Error purchasing item: ${result.error || response.statusText}`);
                }
            } catch (error) {
                console.error("Error purchasing item:", error);
                alert('Network error. Could not connect to API.');
            }
        }

        async function makeOffer(itemId, currentPrice) {
            const buyerId = prompt("Enter your Buyer ID to make an offer:");
            if (!buyerId) return;
            
            if (buyerId === document.getElementById('ownerId').value) {
                alert("You cannot make an offer on your own item!");
                return;
            }

            let offeredPrice;
            while (true) {
                const offerInput = prompt(`Enter your offer price (must be less than $${currentPrice.toFixed(2)}):`);
                if (offerInput === null) return;
                offeredPrice = parseFloat(offerInput);
                
                if (isNaN(offeredPrice) || offeredPrice <= 0) {
                    alert("Please enter a valid price.");
                } else if (offeredPrice >= currentPrice) {
                    alert(`Your offer $${offeredPrice.toFixed(2)} is not a bargain. Try a lower price or use Buy Now.`);
                } else {
                    break;
                }
            }

            try {
                const response = await fetch(`${API_BASE_URL}/items/${itemId}/offer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buyerId, offeredPrice })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Offer successful! Offer ID ${result.id} made by ${buyerId} for $${offeredPrice.toFixed(2)}. Status: ${result.status}`);
                    fetchItems();
                } else {
                    alert(`Error making offer: ${result.error || response.statusText}`);
                }
            } catch (error) {
                console.error("Error making offer:", error);
                alert('Network error. Could not connect to API.');
            }
        }

        async function acceptOffer(itemId, offerId) {
            const ownerId = prompt("Enter the Owner ID to accept this offer:");
            if (!ownerId) return;

            if (!confirm(`Are you sure you want Owner ${ownerId} to accept Offer ID ${offerId} for Item ${itemId}?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/items/${itemId}/offer/${offerId}/accept`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ownerId })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Offer accepted! Item ${itemId} is now SOLD for $${result.item.price.toFixed(2)}.`);
                    fetchItems();
                } else {
                    alert(`Error accepting offer: ${result.error || response.statusText}`);
                }
            } catch (error) {
                console.error("Error accepting offer:", error);
                alert('Network error. Could not connect to API.');
            }
        }

        function renderItems(items) {
            itemListContainer.innerHTML = '';

            items.forEach(item => {
                const isAvailable = item.status === 'Available';
                const statusColor = isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                const itemHtml = `
                    <div class="card p-5 border rounded-lg shadow-md ${isAvailable ? 'bg-white' : 'bg-gray-50 opacity-70 border-red-300'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 truncate">${item.name}</h3>
                                <p class="text-3xl font-extrabold text-indigo-600">$${item.price.toFixed(2)}</p>
                            </div>
                            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${item.status}
                            </span>
                        </div>
                        
                        <p class="text-sm text-gray-500 mb-3">${item.description}</p>
                        
                        <div class="text-xs text-gray-400 mb-4 border-t pt-2">
                            Owner: ${item.ownerId} | ID: ${item.id}
                        </div>

                        ${isAvailable ? `
                            <div class="flex space-x-2">
                                <button onclick="buyItem(${item.id}, ${item.price})"
                                    class="flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-500 hover:bg-indigo-600">
                                    Buy Now
                                </button>
                                <button onclick="makeOffer(${item.id}, ${item.price})"
                                    class="flex-1 py-2 px-4 border border-indigo-500 rounded-md shadow-sm text-sm font-medium text-indigo-500 bg-white hover:bg-indigo-50">
                                    Make Offer
                                </button>
                            </div>
                            <div class="mt-3 text-center">
                                <span class="text-xs text-gray-500 italic">Example Offer Acceptance:</span>
                                <button onclick="acceptOffer(${item.id}, 1)"
                                    class="mt-1 w-full py-1 px-4 text-xs font-medium text-purple-700 bg-purple-100 rounded-md hover:bg-purple-200">
                                    Simulate Owner Accepting Offer 1
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                itemListContainer.innerHTML += itemHtml;
            });
        }

        addItemForm.addEventListener('submit', addItem);

        document.addEventListener('DOMContentLoaded', fetchItems);
    </script>
</body>
</html>